<?php
/**
 * Linia
 * Linia del fichero CSV que importaremos
 *
 * @author Josep Rius
 * @package Eka
 */
class Line {
	private $post_id;
	private $title;
	private $image;
	private $short;
	private $long;
	private $published;

	private $Log;
	private $proc;
	private $sql;

	/**
	 * @param mysqli $sql
	 */
	public function __construct(mysqli $sql) {
		$this -> proc = new XsltProcessor();
		$this -> Log = new Log();
		$this -> sql = $sql;
	}

	public function getID() {
		return $this -> post_id;
	}

	public function getTitle() {
		return $this -> title;
	}

	public function getImage() {
		$domain = 'http://aavvmadrid.org/';

		$image = new SimpleXMLElement($this -> image);

		if ($image['url'] != "") {
			return $domain . $image['url'];
		} else {
			return "";
		}
	}

	/**
	 * getPublished
	 *
	 * Returns the published date in pretty format :)
	 *
	 * @return string
	 */
	public function getPublished() {
		$time = DateTime::createFromFormat('U', $this -> published);
		return $time -> format('Y-m-d H:i:s');
	}

	/**
	 * getShort
	 *
	 * Get the short text
	 *
	 * @param bool $html If set to true tries to convert the text from XML to HTML
	 * @return string
	 */
	public function getShort($html = true) {
		if ($html) {
			$text = $this -> xmlToHtml($this -> short, 'short');
		} else {
			$text = $this -> short;
		}
		return str_replace('"', '”', $text);
	}

	/**
	 * getlong
	 *
	 * Get the long text
	 *
	 * @param bool $html If set to true tries to convert the text from XML to HTML
	 * @return string
	 */
	public function getLong($html = true) {
		$textXML = $this -> long;

		if ($html) {
			$text = substr($this -> xmlToHtml($this -> long, 'long'), 0, -1);
		} else {
			$text = $this -> long;
		}

		// Check for Links -> Change ID for URL
		$data = new SimpleXMLElement($textXML);
		foreach ($data -> xpath('//link') as $enlace) {
			$query = "SELECT * FROM ezurl WHERE id = " . $enlace['url_id'];
			$a = $this -> sql -> query($query);
			$link = $a -> fetch_object();
			if ($a -> num_rows == 0) {
				$this -> Log -> writeLineError($this, "Link no existe " . $enlace['url_id']);
			} else {
				$text = str_ireplace('url_id="' . $enlace['url_id'] . '">', 'url_id="' . $link -> url . '">', $text);
			}
			$a -> close();
		}

		return str_replace('"', '”', $text);
	}

	public function setId($a) {
		$this -> post_id = $a;
	}

	public function setTitle($a) {
		$this -> title = str_replace('"', '”', $a);
	}

	public function setImage($a) {
		$this -> image = $a;
	}

	public function setPublished($a) {
		$this -> published = $a;
	}

	public function setShort($a) {
		$this -> short = $a;
	}

	/**
	 * setLong
	 *
	 * @param string $xml
	 */
	public function setLong($xml) {
		$this -> long = $xml;
	}

	/**
	 * clearLine
	 *
	 * Emptys the object
	 */
	public function clearLine() {
		$this -> title = '';
		$this -> image = '';
		$this -> short = '';
		$this -> long = '';
		$this -> published = 0;
	}

	public function debugImage() {
		$image = new SimpleXMLElement($this -> image);
		print_r($image);
	}

	public function printLine() {
		//TODO Controlar que tots els camps estiguin plens i fer un log de problemes
		echo "<pre>";
		echo 'TITLE:' . $this -> getTitle() . '<br>';
		echo 'IMAGE:' . $this -> getImage() . '<br>';
		echo 'SHORT:' . $this -> getShort() . '<br>';
		echo 'LONG:' . $this -> getLong() . '<br>';
		echo 'PUBLISHED:' . $this -> getPublished();
		echo "</pre><br />";
	}

	/**
	 * printLineCSV
	 *
	 * Return line in CSV format or with the specified char.
	 * All the fields goes between " and comma separated
	 *
	 * @param char $sC Separator character
	 * @return string
	 */
	public function printLineCSV($sC = ',') {
		// Control errores
		if ($this -> long == "") {
			$this -> Log -> writeLineError($this, "Cuerpo vacio");
		} elseif ($this -> short == "") {
			$this -> Log -> writeLineError($this, "Excerpt vacio");
		}

		//$titols = '"post_id","post_title","post_type","post_status","post_date","post_category","post_thumbnail","post_excerpt","post_content"';
		$linia = '"' . $this -> post_id . '"' . $sC;
		$linia .= '"' . $this -> getTitle() . '"' . $sC;
		$linia .= '"post"' . $sC;
		$linia .= '"publish"' . $sC;
		$linia .= '"' . $this -> getPublished() . '"' . $sC;
		$linia .= '"' . $this -> getCategory() . '"' . $sC;
		$linia .= '"' . $this -> getImage() . '"' . $sC;
		$linia .= '"' . $this -> getShort() . '"' . $sC;
		$linia .= '"' . $this -> getLong() . '"';

		return $linia;
	}

	/**
	 * xmlToHtml
	 *
	 * Converts EZ xml to HTML using the ez functions
	 *
	 * @param $XMLContent string XML content
	 * @param $type [long|short] Indicate if is excerpt or body
	 * @return string
	 */
	private function xmlToHtml($XMLContent, $type) {
		$xslt = new DOMDocument();
		$xml = new DOMDocument();

		$GoodContent = utf8_encode($XMLContent);
		$GoodContent = iconv('UTF-8', 'UTF-8//IGNORE', $XMLContent);

		if (!$xml -> loadXML($GoodContent)) {
			$this -> Log -> writeLineError($this, "Error al cargar el XML $type" . $GoodContent);
		}

		if ($type == 'short') {
			$xslt -> load("inc/excerpt.xslt");
		} else {
			$xslt -> load("inc/map.xslt");
		}
		$this -> proc -> importStylesheet($xslt);

		return $this -> proc -> transformToXML($xml);
	}

	/**
	 * Chapuza para saber la subcategoria
	 *
	 * @return string
	 */
	private function getCategory() {
		$webConsumidor = array('3260', '3258', '3257', '3256', '3255', '3254', '3253', '3252', '3250', '3249');
		$antenasTelefono = array('944', '947', '991', '1101', '1102', '1103', '1104', '1105', '1106', '1107', '1236', '1237', '1251', '1395', '1758', '2075', '2167', '2947', '3116', '3495', '3510', '3608', '4128', '9003', '9119', '9197', '9255', '9390', '9501', '10012', '10279', '10376', '10642', '10653', '11336', '11423', '11630', '11821', '12184', '12236', '12280', '12442', '12576', '12819', '12822', '13208', '13310', '13508', '13725', '13780', '14672', '15311', '15629', '16031', '19350', '19508', '19553', '20366', '22001', '22363', '22427', '24202', '24735', '24746', '24783', '24820', '25087', '25393', '25470', '25957', '27126', '27237', '27650', '27751', '28496', '28789', '29531', '29614');
		$benestarSocial = array('892', '1657', '3513', '4926', '4949', '6240', '6311', '6318', '6590', '8823', '11296', '11720', '11995', '12032', '12115', '12206', '12998', '13022', '13123', '13146', '13229', '13252', '13691', '13930', '13985', '14734', '15347', '15738', '27309', '27344', '28865', '28942', '29076', '29083', '29207', '29599', '29678', '29742', '29778');
		$planesBarrio = array('8527', '8630', '9755', '10094', '11316', '13090', '13227', '13779', '18472', '18573', '19422', '19649', '22328', '22459', '22499', '24087', '25493', '25538', '25868', '26204', '26962', '29159');
		$migraciones = array('7123', '7815', '7933', '8722', '9641', '10765', '11753', '12003', '12010', '12149', '12445', '12497', '12521', '12915', '13253', '13328', '13702', '13761', '14116', '14240', '15631', '18106', '19036', '19864', '24741', '25927', '26222', '29071', '29197', '29590');
		$mayores = array('11668', '19768', '24959', '25065', '25145', '26004', '27378', '28143', '28365', '28704');
		$participacion = array('884', '885', '886', '887', '888', '889', '890', '891', '893', '895', '896', '897', '898', '899', '900', '1135', '1136', '1137', '1138', '1139', '1140', '1216', '1217', '1221', '1878', '2505', '2562', '3039', '3055', '3122', '3291', '3490', '3856', '4569', '4989', '5085', '5252', '5314', '5411', '5523', '5579', '6516', '6592', '7335', '7459', '8599', '8912', '8956', '8959', '9108', '10284', '10466', '10511', '10526', '11759', '12130', '12177', '12258', '12260', '12438', '12526', '12582', '12595', '13635', '13674', '14959', '15286', '16913', '18276', '18712', '18759', '18848', '20231', '20519', '21429', '22006', '22120', '24060', '24085', '24145', '24146', '24239', '24287', '24330', '24342', '24345', '24362', '24366', '24486', '24575', '24641', '24666', '24680', '24709', '24710', '24786', '24813', '25463', '25932', '25962', '26299', '26387', '26578', '26841', '26842', '26869', '26891', '26950', '26961', '26963', '27009', '27046', '27051', '27689', '27891', '28267', '28290', '28354', '28524', '28761', '28830', '28837', '28873', '28888', '28938', '28962', '29059', '29500', '29525', '29644', '29649', '29666');
		$planes = array('894', '983', '1362', '1390', '1838', '1879', '2038', '2395', '2637', '2928', '4748', '4945', '5083', '5138', '5731', '6195', '6496', '6728', '6814', '7082', '8445', '10590', '11600', '12871', '15507', '15706', '17192', '26616');
		$centro = array('1985');
		$vivienda = array('904', '905', '906', '908', '909', '910', '911', '912', '913', '914', '915', '916', '917', '918', '919', '921', '922', '923', '924', '926', '927', '1232', '1234', '1629', '1636', '1881', '2081', '2473', '2517', '2733', '2739', '3115', '3127', '3286', '3331', '3648', '3725', '4269', '4408', '4418', '4778', '4818', '4962', '4974', '4976', '6153', '6656', '6776', '6976', '7121', '8034', '8493', '8716', '8996', '8998', '9636', '10328', '10668', '10716', '10729', '10856', '10884', '11057', '11105', '11126', '11361', '11391', '11470', '11499', '11818', '11837', '11925', '12002', '12170', '12356', '12440', '12500', '13153', '13347', '13363', '13690', '13719', '13954', '14126', '14197', '14289', '14517', '14518', '14673', '14705', '14718', '14733', '14788', '14908', '14948', '14976', '15107', '15153', '15155', '15349', '15512', '15524', '15547', '15558', '15621', '15736', '17361', '17718', '18010', '18304', '18432', '18439', '18489', '18698', '18964', '19176', '19275', '19336', '21214', '22105', '22469', '22512', '22572', '24092', '24196', '24238', '24396', '24579', '24679', '24693', '24707', '24719', '24751', '24919', '24986', '25479', '25502', '25503', '25743', '25785', '26096', '26167', '26254', '26583', '26700', '26772', '26904', '26917', '27297', '27334', '27430', '27540', '27720', '28064', '28172', '28230', '28231', '28234', '28249', '28345', '28375', '28386', '28426', '28441', '28468', '28640', '28747', '28809', '28811', '28817', '28824', '28996', '29153', '29167', '29193', '29301', '29446', '29484', '29695');
		$urbanismo = array('857', '928', '929', '930', '931', '932', '933', '934', '935', '939', '940', '965', '966', '967', '968', '970', '972', '973', '974', '1598', '1762', '1764', '1795', '1926', '2028', '2221', '2224', '2697', '2803', '2818', '2821', '2859', '2897', '2994', '3167', '3335', '3345', '3396', '3402', '3414', '3435', '3437', '3462', '3471', '3523', '3573', '3607', '4641', '4742', '4999', '5778', '6185', '6319', '6330', '6353', '6374', '6523', '6563', '6578', '6679', '6691', '6963', '6974', '7039', '7515', '7682', '7969', '8137', '8139', '8283', '8337', '8364', '8502', '8582', '8972', '9131', '9150', '9239', '9245', '9256', '9735', '10283', '10336', '10508', '10626', '10644', '10766', '11128', '11209', '11287', '11726', '12355', '12372', '12593', '12597', '12828', '12878', '12945', '12965', '13093', '13484', '14684', '14956', '15139', '16251', '16265', '16365', '18519', '18620', '18700', '18925', '19062', '19347', '19580', '19666', '19859', '19880', '20244', '22365', '22573', '24446', '24572', '24664', '24779', '24817', '24879', '25013', '25143', '25392', '25504', '25530', '25622', '26103', '26109', '26480', '26528', '26776', '26800', '26899', '26952', '26960', '26992', '27178', '27191', '27233', '27381', '27404', '27758', '27876', '28235', '28371', '28440', '28486', '28490', '28715', '28723', '28751', '28759', '28800', '28998', '29031', '29072', '29135', '29158', '29187', '29253', '29410', '29589', '29598', '29643', '29647', '29652', '29659', '29669', '29670', '29731', '29739', '29763');
		$sanidad = array('941', '942', '945', '948', '949', '950', '951', '952', '953', '954', '955', '956', '957', '958', '959', '960', '961', '1479', '1621', '1972', '1973', '1994', '2449', '2720', '2760', '2797', '2931', '3014', '3026', '3043', '3088', '3107', '3119', '3120', '3165', '3200', '3289', '3292', '3392', '3401', '3460', '3474', '3575', '3582', '3657', '3712', '3779', '3792', '3794', '3795', '3802', '3804', '3825', '3858', '3910', '4049', '4077', '4417', '4621', '4658', '5001', '5154', '5249', '5332', '5336', '5355', '5528', '5757', '5785', '5860', '5926', '5959', '6024', '6273', '6278', '6305', '6341', '6350', '6370', '6372', '6376', '6377', '6382', '6384', '6385', '6386', '6388', '6390', '6391', '6392', '6395', '6397', '6398', '6399', '6435', '6515', '6554', '6565', '6573', '6601', '6639', '6660', '6662', '6747', '6782', '7034', '7047', '7176', '7324', '7375', '7688', '7712', '7781', '7852', '8177', '8256', '8265', '8652', '8715', '8768', '8931', '9011', '9139', '9198', '9219', '9220', '9226', '9420', '9530', '9540', '9643', '9662', '9782', '9941', '10569', '10574', '10632', '10846', '11036', '11082', '11290', '11357', '11373', '11445', '11487', '11495', '11505', '11561', '11569', '11594', '11595', '11629', '11646', '11655', '11707', '11729', '12142', '12254', '12315', '13077', '13098', '13122', '13254', '13329', '13821', '14366', '14433', '15148', '15149', '15177', '15456', '15510', '15574', '15625', '17138', '17246', '17498', '17681', '18380', '18470', '18517', '18561', '18714', '18734', '18850', '18857', '18912', '18931', '19175', '19235', '19280', '19368', '19395', '19421', '19424', '19428', '19489', '19491', '19550', '19590', '19631', '19731', '19827', '19852', '20087', '20229', '21542', '21799', '22420', '22485', '22527', '23792', '24053', '24331', '24431', '24468', '24676', '24703', '24917', '25026', '25102', '25263', '25387', '25396', '25584', '25880', '26111', '26129', '26647', '26754', '26817', '27017', '27043', '27132', '27726', '27864', '28209', '28224', '28325', '28353', '28487', '28724', '28949', '29052', '29171', '29255', '29409', '29597', '29620', '29630', '29633', '29639', '29648', '29698', '29730');
		$educacion = array('975', '976', '977', '978', '979', '980', '981', '982', '2068', '2549', '2701', '2952', '3683', '3727', '3808', '4784', '4806', '5238', '5477', '6134', '6431', '6542', '6936', '6944', '8133', '8322', '8361', '8797', '8812', '9698', '10544', '10572', '11080', '11256', '11448', '11477', '11485', '11574', '11575', '11586', '11587', '11603', '11634', '11739', '11774', '11912', '12344', '12437', '13207', '13235', '13286', '13330', '13368', '13383', '13615', '13627', '13830', '13994', '14070', '14503', '14736', '14781', '14879', '14884', '14958', '15036', '15055', '15069', '15102', '15103', '15219', '15335', '15365', '15564', '15683', '15708', '15833', '17200', '17929', '19080', '19603', '21153', '22044', '24075', '24199', '24240', '24302', '24363', '24444', '24448', '24509', '24877', '24927', '24963', '24984', '24985', '25021', '25121', '25126', '25150', '25153', '25248', '25266', '25450', '25793', '25811', '26104', '26394', '26439', '26501', '26824', '26989', '27008', '27029', '27080', '27625', '27696', '27753', '27791', '28233', '28275', '28346', '28519', '28987', '28988', '28989', '28990', '29223', '29332', '29338', '29356', '29387', '29442', '29470', '29483', '29485', '29489', '29492', '29501', '29519', '29520', '29546', '29611', '29689', '29692', '29745');
		$medioAmbiente = array('855', '856', '858', '859', '860', '861', '862', '863', '864', '865', '866', '868', '869', '870', '871', '873', '874', '875', '876', '877', '878', '879', '880', '881', '882', '883', '1224', '1590', '1759', '1983', '2222', '2227', '2245', '2339', '2352', '2408', '2441', '2472', '2561', '2704', '2866', '2966', '3076', '3710', '3913', '4523', '4671', '4715', '4782', '4804', '4883', '4995', '5036', '5401', '5738', '5761', '5996', '6004', '6202', '6237', '6304', '6307', '6425', '6463', '6464', '6468', '6500', '6675', '6687', '6774', '6896', '6943', '6985', '6993', '7003', '7013', '7040', '7100', '7142', '7202', '7244', '7276', '7287', '7306', '7322', '7325', '7328', '7337', '7343', '7370', '7419', '7466', '7506', '7728', '7832', '7918', '7944', '7970', '7974', '8018', '8092', '8093', '8221', '8225', '8228', '8255', '8319', '8344', '8448', '8460', '8505', '8510', '8520', '8578', '8601', '8664', '8702', '8813', '8814', '8858', '8929', '9127', '9129', '9151', '9184', '9262', '9272', '9442', '9513', '9709', '9711', '9718', '9766', '9773', '9795', '9838', '9852', '9887', '9989', '10013', '10073', '10077', '10091', '10428', '10468', '10471', '10488', '10524', '10666', '10719', '10730', '10929', '11026', '11206', '11252', '11315', '11335', '11468', '11568', '11570', '11576', '11727', '11772', '11778', '11850', '12103', '12155', '12176', '12186', '12193', '12316', '12353', '12587', '12789', '12805', '12821', '12944', '13003', '13026', '13124', '13209', '13220', '13345', '13380', '13381', '13595', '13629', '13644', '13689', '13848', '13857', '14394', '14691', '14829', '14955', '14975', '15029', '15051', '15104', '15144', '15174', '15194', '15271', '15297', '15345', '15350', '15367', '15419', '15537', '15602', '15635', '15680', '15715', '15718', '17161', '17644', '17717', '17856', '17878', '18151', '18274', '18362', '18379', '18435', '18453', '18475', '19006', '19112', '19127', '19272', '19369', '19417', '19451', '19727', '19855', '19886', '20085', '20100', '21714', '21927', '22086', '22165', '22179', '22202', '22262', '22311', '22484', '22486', '22533', '24120', '24141', '24186', '24203', '24236', '24386', '24403', '24472', '24640', '24745', '24841', '24845', '24903', '24940', '24983', '25086', '25118', '25125', '25142', '25247', '25270', '25292', '25409', '25531', '25539', '25583', '25619', '25629', '25642', '25645', '25814', '25843', '25948', '25955', '25958', '26045', '26199', '26219', '26263', '26315', '26347', '26425', '26547', '26572', '26615', '26649', '26697', '26819', '26999', '27000', '27082', '27194', '27206', '27235', '27272', '27332', '27380', '27468', '27542', '27695', '27742', '27793', '27805', '27843', '27897', '28046', '28117', '28129', '28173', '28175', '28189', '28207', '28262', '28270', '28315', '28323', '28372', '28416', '28417', '28523', '28527', '28532', '28802', '29004', '29037', '29068', '29085', '29208', '29268', '29274', '29285', '29314', '29345', '29398', '29415', '29474', '29529', '29530', '29534', '29535', '29588', '29622', '29629', '29675', '29694', '29740', '29805', );
		$transportes = array('698', '699', '700', '701', '702', '703', '704', '705', '706', '707', '708', '847', '848', '849', '851', '852', '853', '1241', '1600', '1801', '1829', '1896', '2067', '2100', '2121', '2237', '2348', '2499', '2572', '2582', '2899', '3054', '3077', '3275', '3327', '3371', '3397', '3436', '3473', '3482', '3557', '3570', '3655', '3672', '3711', '3729', '3741', '3818', '3893', '3902', '4022', '4399', '4793', '4794', '4837', '4951', '4953', '4997', '4998', '5169', '5412', '5998', '6021', '6840', '6889', '7019', '7101', '7189', '7198', '7632', '8027', '8211', '8214', '8443', '8710', '8757', '8789', '9157', '9430', '9644', '10135', '10205', '10252', '10404', '11079', '11329', '11784', '12345', '12371', '12764', '12941', '13366', '13390', '13487', '14472', '14786', '15246', '15304', '15370', '16651', '16826', '17339', '17396', '17486', '18371', '18945', '19538', '19890', '22468', '24077', '24107', '24252', '24743', '24748', '24888', '24939', '25064', '25066', '25074', '25168', '25181', '25451', '25456', '25515', '25522', '25588', '25618', '25649', '25786', '25865', '26063', '26333', '26622', '26814', '26943', '27528', '27823', '28176', '28384', '28520', '28697', '28799', '28803', '28926', '29032', '29139', '29179', '29196', '29198', '29202', '29269', '29305', '29306', '29309', '29337', '29352', '29397', '29475', '29533', '29650', '29655', '29688', '29779');
		$cultura = array('986', '989', '990', '1252', '1334', '1414', '2283', '2482', '2502', '2634', '4635', '4870', '4941', '4955', '5045', '5130', '6265', '6301', '6706', '7246', '7580', '7631', '7738', '8464', '9240', '9494', '9731', '10427', '10790', '11078', '11161', '11259', '11356', '11371', '11884', '12321', '12740', '12823', '13180', '13340', '13612', '13703', '14455', '15108', '15109', '15173', '15388', '15461', '15624', '18230', '18799', '19415', '19457', '20284', '20481', '21991', '24612', '24835', '25085', '25305', '25455', '25485', '25877', '26574', '26868', '26884', '27138', '27379', '27435', '28124', '28148', '28240', '28319', '28388', '28569', '28571', '28885', '29039', '29249', '29251', '29292', '29424', '29468', '29732', '29737');
		$jovenes = array('5006', '13185', '13389', '13604', '14285', '15306', '19427', '24708', '13626');

		$categorias = "noticias";
		if(in_array($this -> post_id, $webConsumidor)) {
			$categorias .= ",web-consumidor";
		}
		if(in_array($this -> post_id, $antenasTelefono)) {
			$categorias .= ",antenas-telefono";
		}
		if(in_array($this -> post_id, $benestarSocial)) {
			$categorias .= ",benestar-social";
		}
		if(in_array($this -> post_id, $planesBarrio)) {
			$categorias .= ",planes-barrio";
		}
		if(in_array($this -> post_id, $migraciones)) {
			$categorias .= ",migraciones";
		}
		if(in_array($this -> post_id, $mayores)) {
			$categorias .= ",mayores";
		}
		if(in_array($this -> post_id, $participacion)) {
			$categorias .= ",participacion-ciudadana";
		}
		if(in_array($this -> post_id, $planes)) {
			$categorias .= ",planes-especiales";
		}
		if(in_array($this -> post_id, $centro)) {
			$categorias .= ",centro-historico";
		}
		if(in_array($this -> post_id, $vivienda)) {
			$categorias .= ",vivienda";
		}
		if(in_array($this -> post_id, $urbanismo)) {
			$categorias .= ",urbanismo";
		}
		if(in_array($this -> post_id, $sanidad)) {
			$categorias .= ",sanidad";
		}
		if(in_array($this -> post_id, $educacion)) {
			$categorias .= ",educacion";
		}
		if(in_array($this -> post_id, $medioAmbiente)) {
			$categorias .= ",medio-ambiente";
		}
		if(in_array($this -> post_id, $transportes)) {
			$categorias .= ",transportes";
		}
		if(in_array($this -> post_id, $cultura)) {
			$categorias .= ",cultura";
		}
		if(in_array($this -> post_id, $jovenes)) {
			$categorias .= ",jovenes";
		}

		return $categorias;
	}

}
?>
